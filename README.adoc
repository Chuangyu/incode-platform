= incode-module-document
:_imagesdir: ./

image:https://travis-ci.org/incodehq/incode-module-document.png?branch=master[Build Status,link=https://travis-ci.org/incodehq/incode-module-document]

This module, intended for use with link:http://isis.apache.org[Apache Isis], provides the ability to create `Document` objects to arbitrary domain objects. 


== Domain Model

=== Document, DocumentTemplate and Paperclip

The following class diagram highlights the main concepts:

image::http://yuml.me/0ee8631c[link="http://yuml.me/0ee8631c", width="600px"]

(The colours used in the diagram are - approximately - from link:https://en.wikipedia.org/wiki/Object_Modeling_in_Color[Object Modeling in Color]).

The central concept is, of course, `Document`.
``Document``s have content that is either a Blob, Clob or is text, these attributes being defined in the `DocumentAbstract` supertype (more on this shortly).
Alternatively, the ``Document``'s content can be stored externally, eg in a CMS or cloud storage service, in which case the ``Document``'s own `externalUrl` attribute is used.
The `DocumentSort` determines how the content of the `Document` is physically stored (along with the supporting `DocumentNature` and `DocumentStorage` enums).
Conceptually ``Document``s are immutable (though if their content is moved to an external URL, the original entity would be update in that case).

Each `Document` also has a corresponding `DocumentType`, eg "Invoice" or perhaps a form id, eg "ABC123".

The `DocumentTemplate` is also a document (ie subclass of `DocumentAbstract`), however its content will have placeholders.
These placeholders are populated with respect to some sort of domain object acting as an input (like a "mail merge"), to generate a resultant `Document`.
The `DocumentTemplate` also has a `DocumentType`, and so it is the `DocumentType` that acts as the link between the `DocumentTemplate` with the ``Document``s created from those templates.
It is possible for there to be multiple ``DocumentTemplate``s over time for a particular `DocumentType` (distinguished by date), to allow for minor changes to a template over time.
The domain model deliberately does *not* keep track of which particular `DocumentTemplate` was used to create a `Document`, just the type is used.

Each `DocumentTemplate` has a `RenderingStrategy`, this being a mechanism to actually produce its content by interpolating the template text with placeholders.

[NOTE]
====
Actually, each `DocumentTemplate` has two sets of placeholders and also corresponding `RenderingStrategy`s.
The "content" template text is used to generate the actual content of the resultant ``Document``'s content; this could be characters (eg a HTML email) or bytes (eg a PDF).
The "name" template text , while the other is used to interpolate the name of the resultant `Document`; this will always result in a simple character string.
====

Each `DocumentTemplate` also has an associated set of ``Applicability``s.
Each of these identifies a domain class that can be used as an input the rendering of the `DocumentTemplate`, with a corresponding implementation of the `RendererModelFactory` interface being responsible for actually creating an input "renderer model" used to feed into the template's `RenderingStrategy`.
The `Applicability` also defines the implementation of `AttachmentAdvisor` interface; this is used to attach the resultant `Document` to arbitrary domain objects (usually the input domain object, and perhaps others also).

Every `Document` is created from a `DocumentTemplate`, but rather than hold a reference to this original template, instead `Document` and `DocumentTemplate` are unified through the `DocumentType` entity.
The `DocumentType` can be considered as a set of versioned ``DocumentTemplate``s (identified by date), along with all the ``Document``s that were created from (any of) those ``DocumentTemplate``s.

Once a `Document` has been created it is attached to one or more target domain object using `Paperclip`.
This requires a custom subclass for the domain object in question; the polymorphic pattern ("table of two halves") is used for this linkage.

Based upon the implementation of `RenderingStrategy` and `Renderer`, each `DocumentTemplate` can support either previewing and/or rendering.
Previewing means to return a representation as a URL; the end-user can then navigate to this URL without any change in state to the application.
Rendering on the other hand means the creation and persisting of a `Document` from the `DocumentTemplate`.

The `createAndAttachDocumentAndRender()` mixin is contributed to all domain objects where there is a `DocumentTemplate` available for the domain object's application tenancy path (`atPath`) that supports either previewing and/or rendering.
The similar `createAndAttachDocumentAndScheduleRender()` mixin is also available, allowing the rendering to be performed as a background task (eg using (non-ASF) http://github.com/isisaddons/isis-module-command[Isis addons' command] module.



=== RenderingStrategy & Renderer

The  `Renderer` interface has the following subtypes and (example) implementations:

image::http://yuml.me/b63e782f[link="http://yuml.me/b63e782f", width="800px"]

The owning `RenderingStrategy` for each `Renderer` identifies the nature of the inputs and outputs (bytes or characters) of each `RenderingStrategy`; the associated `Renderer` implementation must meet those constraints.
Note that a `Renderer` may produce nature of the inputs vs outputs may vary: a character template might result in byte array output.





== How to run the Demo App

The prerequisite software is:

* Java JDK 8
* http://maven.apache.org[maven 3] (3.2.x or later is recommended).

To build the demo app:

[source]
----
git clone https://github.com/incodehq/isis-module-document.git
mvn clean install
----

To run the demo app:

[source]
----
cd webapp
mvn jetty:run
----

Then log on using user: `sven`, password: `pass`



== How to configure/use

You can either use this module "out-of-the-box", or you can fork this repo and extend to your own requirements. 

=== "Out-of-the-box"

To use "out-of-the-box":

* update your classpath by adding this dependency in your dom project's `pom.xml`: +
+
[source,xml]
----
<dependency>
    <groupId>org.incode.module.document</groupId>
    <artifactId>incode-module-document-dom</artifactId>
    <version>1.13.10</version>
</dependency>
----

* in the `AppManifest`, update its `getModules()` method: +
+
[source,java]
----
@Override
public List<Class<?>> getModules() {
    return Arrays.asList(
            ...
            org.incode.module.document.dom.DocumentModule.class,
    );
}
----



Notes:

* Check for later releases by searching http://search.maven.org/#search|ga|1|incode-module-document-dom[Maven Central Repo].


==== "Out-of-the-box" (-SNAPSHOT)

If you want to use the current `-SNAPSHOT`, then the steps are the same as above, except:

* when updating the classpath, specify the appropriate -SNAPSHOT version:

[source,xml]
----
<version>1.14.0-SNAPSHOT</version>
----

* add the repository definition to pick up the most recent snapshot (we use the Cloudbees continuous integration service).  
We suggest defining the repository in a `<profile>`:

[source,xml]
----
<profile>
    <id>cloudbees-snapshots</id>
    <activation>
        <activeByDefault>true</activeByDefault>
    </activation>
    <repositories>
        <repository>
            <id>snapshots-repo</id>
            <url>http://repository-estatio.forge.cloudbees.com/snapshot/</url>
            <releases>
                <enabled>false>/enabled>
            </releases>
            <snapshots>
                <enabled>true</enabled>
            </snapshots>
        </repository>
    </repositories>
</profile>
----


=== Input

For each domain object class that you want to use as the input data to a `DocumentTemplate`, you need to:

* implement `ApplicationTenancyService` +
+
To return the application tenancy path of the domain object in order that available ``DocumentTemplate``s can be located: +
+
[source,java]
----
public interface ApplicationTenancyService {
    String atPathFor(final Object domainObject);
}
----

* implement a `RendererModelFactory` +
+
This constructs the "renderer model" from the input domain object, which is then fed into the `RenderingStrategy` of the `DocumentTemplate`: +
+
[source,java]
----
public interface RendererModelFactory {
    @Programmatic
    Object newRendererModel(
            DocumentTemplate documentTemplate,    // <1>
            Object domainObject);                 // <2>
}
----
<1> the template to which this implementation applies, as per `DocumentTemplate#getAppliesTo()` and `Applicability#getRendererModelFactoryClassName()` +
<2> provides the input for the renderer model +
+
[TIP]
====
The `RendererModelFactoryAbstract<T>` can be used to implement the `RendererModelFactory` interface, adding the capability of verifying the input document is of the correct type.
====


* implement a `AttachmentAdvisor` +
+
This returns a data structure (``List<PaperclipSpec>``) which describes to which object(s) the resultant `Document` should be attached: +
+
[source,java]
----
public interface AttachmentAdvisor {
    @lombok.Data                                // <1>
    public static class PaperclipSpec {
        private final String roleName;
        private final Object attachTo;
    }
    List<PaperclipSpec> advise(
            DocumentTemplate documentTemplate,  // <2>
            Object domainObject);               // <3>
}
----
<1> immutable value type, defined using link:https://projectlombok.org/features/Data.html[`@Data`] annotation from Project Lombok +
<2> to which this implementation applies, as per `DocumentTemplate#getAppliesTo()` and `Applicability#getAttachmentAdvisorClassName()` +
<3> acting as the context for document created, from which derive the objects to attach the newly created `Document` +
+
The`PaperclipSpec` describes how create instances of `Paperclip` from attach the resultant `Document` to other
domain objects. +
+
[TIP]
====
The `AttachmentAdvisorAbstract<T>` can be used to implement the `AttachmentAdvisor` interface, adding the capability of verifying the input document is of the correct type.
====


=== Renderers

For each rendering technology, an implementation of `Renderer` is required.  
A number of such ``Rendererer``s have been developed, using Freemarker, XDocReport or just capturing the content of arbitrary URLs (eg as exposed by an external reporting server such as SQL Server Reporting Services).



=== Paperclips (attach output)

For each domain object that you want to attach ``Document``s (that is, add ``Paperclip``s to), you need to

* implement a subclass of `Paperclip` for the domain object's type. +
+
This link acts as a type-safe tuple linking the domain object to the `Document`.

* implement the `PaperclipRepository.SubtypeProvider` SPI interface: +
+
[source,java]
----
public interface SubtypeProvider {
    Class<? extends Paperclip> subtypeFor(Class<?> domainObject);
}
----
+
This tells the module which subclass of `Paperclip` to use to attach to the domain object to attach to.  
The `SubtypeProviderAbstract` adapter can be used to remove some boilerplate.


For example:

[source,java]
----
@javax.jdo.annotations.PersistenceCapable(identityType=IdentityType.DATASTORE)
@javax.jdo.annotations.Inheritance(strategy = InheritanceStrategy.NEW_TABLE)
@DomainObject(objectType = "estatioAssets.PaperclipForInvoice")
@DomainObjectLayout( bookmarking = BookmarkPolicy.AS_ROOT)
public class PaperclipForInvoice extends Paperclip {                    // <1>

    @Column( allowsNull = "false", name = "invoiceId" )
    @Getter @Setter
    private Invoice invoice;

    @NotPersistent
    @Override
    public Object getAttachedTo() {                                     // <2>
        return getInvoice();
    }
    @Override
    protected void setAttachedTo(final Object object) {
        setInvoice((Invoice) object);
    }

    @DomainService(nature = NatureOfService.DOMAIN)
    public static class SubtypeProvider                                 // <3>
            extends PaperclipRepository.SubtypeProviderAbstract {
        public SubtypeProvider() {
            super(Invoice.class, PaperclipForInvoice.class);
        }
    }
}
----
<1> inherit from `Paperclip`
<2> implement hook methods
<3> SubtypeProvider SPI implementation


[NOTE]
====
To view the ``Paperclip``s once created there is also a `T_paperclips` mixin collection, discussed below.
====


=== Mixins

==== T_createDocumentAndRender, T_createDocumentAndScheduleRender

The document module is fully data-driven, in that the ability to be able to create a document for any given domain entity is defined by the data held in `DocumentTemplate` (its `atPath`) and `Applicability` (the `domainClassName` and corresponding `RendererModelFactory` and `AttachmentAdvisor` implementations).

The `T_createDocumentAndRender` and `T_createDocumentAndScheduleRender` mixin actions exposes this functionality for any domain class, by simply subclassing. 
The former renders in the foreground, while the latter creates a background command so that the rendering can be performed asynchronously.

For example:

[source,java]
----
@Mixin
public class Invoice_createDocument extends T_createDocumentAndRender<Invoice> {
    public Invoice_createDocument(Invoice invoice) { super(invoice); }
}
----

Add similar mixins for all classes where there exists a `DocumentTemplate` and `Applicability` capable of consuming the object as an input to the template.

[TIP]
====
If you want make this action available for all domain objects, simply use:

[source,java]
----
@Mixin
public class Object_createDocument extends T_createDocumentAndRender<Object> {
    public Object_createDocument(Object object) { super(object); }
}
----

If there is no `DocumentTemplate`/`Applicability`, then the action will be hidden in the UI.  
The reason that the module doesn't just provide this mixin out-of-the-box is (a) for consistency with other modules and (b) for understandability/traceability ("not *too* much magic").
====


==== T_documents

The `T_documents` mixin collection returns the list of ``Paperclip``s that each attach a `Document` to the specified domain object.

Since ``Paperclip``s can only be created for domain objects where a subclass of `Paperclip` has been defined (see above), it's typical for this mixin to be defined as a nested static class of that `Paperclip` subclass.
For example:

[source,java]
----
...
public class PaperclipForInvoice extends Paperclip {
    ...
    @Mixin
    public static class _documents extends T_paperclips<Invoice> {
        public _documents(final Invoice invoice) {
            super(invoice);
        }
    }
}
----


=== Services (API)

The `DocumentCreatorService` service allows documents to be created and attached (using ``Paperclip``s) programmatically to other domain objects.

The API is:

[source,java]
----
public class DocumentCreatorService {
    public boolean canCreateDocumentAndAttachPaperclips(        // <1>
            Object domainObject,
            DocumentTemplate template);
    public Document createDocumentAndAttachPaperclips(          // <2>
            Object domainObject,
            DocumentTemplate template);
}
----
<1> allows a programmatic check as to whether the provided `DocumentTemplate` is applicable to the domain object.
<2> go ahead and actually create the new `Document`, attaching it as specified by the `AttachmentAdvisor` associated with the ``DocumentTemplate`` ('s `Applicability` for this domain object).


=== Optional (SPI) Services

==== UrlDownloadService

The `UrlDownloadService` is used to download any ``Document``s whose content is stored as an external URL, eg in an on-site CMS or on a cloud storage service.

A default implementation of this service is provided that simply uses Java's `HttpUrlConnection` to download the URL; in particular the URL must be accessible and require no user credentials/passwords.

The service can be optionally overridden if credentials are required.

The service is defined as:

[source,java]
----
public interface UrlDownloadService {
    public Blob downloadAsBlob(final Document document) { ... }
    public Clob downloadAsClob(final Document document) { ... }
}
----


==== RendererModelFactoryClassNameService

The `RendererModelFactoryClassNameService`, if implemented, provides UI to allow the renderer model factory class name to be changed on an `Applicability`:

[source,java]
----
public interface RendererModelFactoryClassNameService {
    List<ClassNameViewModel> rendererModelFactoryClassNames();
}
----

This can most conveniently be implemented using the `ClassNameServiceAbstract` convenience class, eg:

[source,java]
----
@DomainService(nature = NatureOfService.DOMAIN)
public class RendererModelFactoryClassNameServiceForDemo extends ClassNameServiceAbstract<RendererModelFactory>
                                                         implements RendererModelFactoryClassNameService {
    public RendererModelFactoryClassNameServiceForDemo() {
        super(RendererModelFactory.class, "org.incode.module.document.fixture");
    }
    public List<ClassNameViewModel> rendererModelFactoryClassNames() {
        return this.classNames();
    }
}
----


==== AttachmentAdvisorClassNameService

The `AttachmentAdvisorClassNameService`, if implemented, provides UI to allow the renderer model factory class name to be changed on an `Applicability`:

[source,java]
----
public interface AttachmentAdvisorClassNameService {
    List<ClassNameViewModel> attachmentAdvisorClassNames();
}
----

Like `RendererModelFactoryClassNameService` (above), this can most conveniently be implemented using the `ClassNameServiceAbstract` convenience class.



==== RendererClassNameService

The `RendererClassNameService`, if implemented, provides UI to allow the renderer class name to be changed on an `Applicability`:

[source,java]
----
public interface RendererClassNameService {
    public List<ClassNameViewModel> renderClassNamesFor(
            final DocumentNature inputNature,
            final DocumentNature outputNature);
    <C extends Renderer> Class<C> asClass(final String className);
}
----

This can most conveniently be implemented using the `ClassNameServiceAbstract` convenience class, eg:

[source,java]
----
@DomainService(nature = NatureOfService.DOMAIN)
public class RendererClassNameServiceForDemo extends ClassNameServiceAbstract<Renderer>
                implements RendererClassNameService {
    public RendererClassNameServiceForDemo() {
        super(Renderer.class, "org.incode.module.document.fixture");
    }
    public List<ClassNameViewModel> renderClassNamesFor(
            final DocumentNature inputNature, final DocumentNature outputNature) {
        if(inputNature == null || outputNature == null){
            return Lists.newArrayList();
        }
        return classNames(x -> inputNature.canActAsInputTo(x) && outputNature.canActAsOutputTo(x));
    }
    public Class<Renderer> asClass(final String className) {
        return super.asClass(className);
    }
}
----




== Known issues

(none)


== Change Log

* `1.13.10` - released against Isis 1.13.0.  Fixes https://github.com/incodehq/incode-module-document/issues/3[#3], https://github.com/incodehq/incode-module-document/issues/4[#4], https://github.com/incodehq/incode-module-document/issues/5[#5], https://github.com/incodehq/incode-module-document/issues/6[#6], https://github.com/incodehq/incode-module-document/issues/7[#7], https://github.com/incodehq/incode-module-document/issues/8[#8].   NB: this release is also *not* backward compatible with the previous release.
* `1.13.6` - released against Isis 1.13.0.  Fixes https://github.com/incodehq/incode-module-document/issues/2[#2]
* `1.13.5` - released against Isis 1.13.0.  Fixes https://github.com/incodehq/incode-module-document/issues/1[#1], with various additional extensions to functionality.  NB: this release is *not* backward compatible with the previous release.
* `1.13.0` - released against Isis 1.13.0



== Forking the repo

If instead you want to extend this module's functionality, then we recommend that you fork this repo.  The repo is
structured as follows:

* `pom.xml` - parent pom
* `dom` - the module implementation, depends on Isis applib


////////////////////////////////////////////////////
* `app` - the demo webapp's `AppManifest`
* `fixture` - fixtures, holding a sample domain objects and fixture scripts; depends on `dom`
* `integtests` - integration tests for the module; depends on `fixture`
* `webapp` - demo webapp (see above screenshots); depends on `dom` and `fixture`

Only the `dom` project is released to Maven Central Repo.  The versions of the other modules are purposely left at
`0.0.1-SNAPSHOT` because they are not intended to be released.

////////////////////////////////////////////////////

Note that the module uses link:https://projectlombok.org/[Project Lombok].  To compile the code within your IDE you will
therefore require the appropriate Lombok plugin.  See the link:https://projectlombok.org/download.html[Lombok download page] for more information.


== Legal Stuff

=== License

[source]
----
Copyright 2016 Dan Haywood

Licensed under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
----

=== Dependencies

None.


=== Icons

The icons are provided by https://icons8.com/[Icons8].


==  Maven deploy notes

Only the `dom` module is deployed, and is done so using Sonatype's OSS support (see
http://central.sonatype.org/pages/apache-maven.html[user guide]).

=== Release to Sonatype's Snapshot Repo

To deploy a snapshot, use:

[source]
----
pushd dom
mvn clean deploy
popd
----

The artifacts should be available in Sonatype's
https://oss.sonatype.org/content/repositories/snapshots[Snapshot Repo].



=== Release an Interim Build

If you have commit access to this project (or a fork of your own) then you can create interim releases using the `interim-release.sh` script.

The idea is that this will - in a new branch - update the `dom/pom.xml` with a timestamped version (eg `1.13.0.20161017-0738`).
It then pushes the branch (and a tag) to the specified remote.

A CI server such as Jenkins can monitor the branches matching the wildcard `origin/interim/*` and create a build.
These artifacts can then be published to a snapshot repository.

For example:

[source]
----
sh interim-release.sh 1.14.0 origin
----

where

* `1.14.0` is the base release
* `origin` is the name of the remote to which you have permissions to write to.




=== Release to Maven Central

The `release.sh` script automates the release process. It performs the following:

* performs a sanity check (`mvn clean install -o`) that everything builds ok
* bumps the `pom.xml` to a specified release version, and tag
* performs a double check (`mvn clean install -o`) that everything still builds ok
* releases the code using `mvn clean deploy`
* bumps the `pom.xml` to a specified release version

For example:

[source]
----
sh release.sh 1.14.0 \
              1.15.0-SNAPSHOT \
              dan@haywood-associates.co.uk \
              "this is not really my passphrase"
----

where
* `$1` is the release version
* `$2` is the snapshot version
* `$3` is the email of the secret key (`~/.gnupg/secring.gpg`) to use for signing
* `$4` is the corresponding passphrase for that secret key.

Other ways of specifying the key and passphrase are available, see the `pgp-maven-plugin`'s
http://kohsuke.org/pgp-maven-plugin/secretkey.html[documentation]).

If the script completes successfully, then push changes:

[source]
----
git push origin master
git push origin 1.14.0
----

If the script fails to complete, then identify the cause, perform a `git reset --hard` to start over and fix the issue
before trying again.  Note that in the `dom`'s `pom.xml` the `nexus-staging-maven-plugin` has the 
`autoReleaseAfterClose` setting set to `true` (to automatically stage, close and the release the repo).  You may want
to set this to `false` if debugging an issue.

According to Sonatype's guide, it takes about 10 minutes to sync, but up to 2 hours to update http://search.maven.org[search].


= incode-module-note
:_imagesdir: ./

image:https://travis-ci.org/incodehq/incode-module-note.png?branch=master[Build Status,link=https://travis-ci.org/incodehq/incode-module-note]

This module, intended for use with link:http://isis.apache.org[Apache Isis], provides the ability to attach `Note`
objects to arbitrary domain objects.  There are _no_ requirements for those domain objects implement any interfaces.
A subclass of the `NotableLink` abstract class is required (about link:https://github.com/incodehq/incode-module-note/blob/master/fixture/src/main/java/org/incode/module/note/fixture/dom/notablelink/NotableLinkForDemoObject.java[50 lines of boilerplate])),
acting as the "glue" between the note and the "notable" domain object.

Each `Note` can optionally have a date associated with it, and corresponding (predefined) calendar.  The `Note`
implements the `CalendarEventable` interface (from the link:http://isisaddons.org[Isis Addons]'
link:http://github.com/isisaddons/isis-wicket-fullcalendar2[fullcalendar2]) wicket component) meaning that they can
then be rendered in a calendar view.  This makes the notes useful for a simple task list.

The optional `CalendarNameRepository` SPI service is used to enumerate the calendars for any given "notable" domain
object.  The list of available calendars is determined by the "notable": if `Customer` and `Order` both are "notable",
then the `CalendarNameRepository` could provide different calendar names for each.  If no implementation of
the `CalendarNameRepository` service can be found, then a single "default" calendar is used.

Any given "notable" domain object can have multiple ``Note``s.  As currently implemented, a "notable" domain object can
only have one `Note` per named calendar.



== Domain Model

The following http://yuml.me[] class diagram highlights the main concepts:

image::http://yuml.me/55b7eaab[link="http://yuml.me/55b7eaab"]

(The colours used in the diagram are - approximately - from link:https://en.wikipedia.org/wiki/Object_Modeling_in_Color[Object Modeling in Color]).




== Screenshots

The following screenshots show an example app's usage of the module.

We start by installing some demo fixture data:

image::https://raw.githubusercontent.com/incodehq/incode-module-note/master/images/010-run-fixture-script.png[link="https://raw.githubusercontent.com/incodehq/incode-module-note/master/images/010-run-fixture-script.png"]

This installs some very simple domain objects to which we want to attach notes:

image::https://raw.githubusercontent.com/incodehq/incode-module-note/master/images/020-list-all.png[link="https://raw.githubusercontent.com/incodehq/incode-module-note/master/images/020-list-all.png"]

These are our "notable" domain objects.

image::https://raw.githubusercontent.com/incodehq/incode-module-note/master/images/030-view-domain-object.png[link="https://raw.githubusercontent.com/incodehq/incode-module-note/master/images/030-view-domain-object.png"]

The fixture sets up some notes for each of these "notable" objects; these are displayed in a (contributed) `notes` collection.  We can also add new notes using a (contributed) `addNote(...)` action:

image::https://raw.githubusercontent.com/incodehq/incode-module-note/master/images/040-add-note.png[link="https://raw.githubusercontent.com/incodehq/incode-module-note/master/images/040-add-note.png"]

The action allows the note text and optionally a date/calendar to be specified.  Every note must have either text and/or a date and calendar.  Also, each "notable" can only associate one `Note` per calendar.  The list of calendars is defined by the optional `CalendarNameRepository` SPI domain service, discussed below:

image::https://raw.githubusercontent.com/incodehq/incode-module-note/master/images/050-enter-note-details.png[link="https://raw.githubusercontent.com/incodehq/incode-module-note/master/images/050-enter-note-details.png"]

The notes for the "notable" domain object is added to.  Each `Note` can also be viewed:

image::https://raw.githubusercontent.com/incodehq/incode-module-note/master/images/060-note-added-to-collection.png[link="https://raw.githubusercontent.com/incodehq/incode-module-note/master/images/060-note-added-to-collection.png"]

The `Note` shows the text and date/calendar, as well as the "notable" domain object that it is attached to.

image::https://raw.githubusercontent.com/incodehq/incode-module-note/master/images/070-view-note.png[link="https://raw.githubusercontent.com/incodehq/incode-module-note/master/images/070-view-note.png"]

The `changeNote(...)` action allows the note text to be updated (or cleared/set to null if the note has a date/calendar):

image::https://raw.githubusercontent.com/incodehq/incode-module-note/master/images/080-change-note-text.png[link="https://raw.githubusercontent.com/incodehq/incode-module-note/master/images/080-change-note-text.png"]

while the `changeDate(...)` action...

image::https://raw.githubusercontent.com/incodehq/incode-module-note/master/images/090-change-date.png[link="https://raw.githubusercontent.com/incodehq/incode-module-note/master/images/090-change-date.png"]

allows the note's date/calendar to be updated (or cleared/set to null if the note has text):

image::https://raw.githubusercontent.com/incodehq/incode-module-note/master/images/100-change-date-details.png[link="https://raw.githubusercontent.com/incodehq/incode-module-note/master/images/100-change-date-details.png"]

Each `Note` implements the (non-ASF) http://github.com/isisaddons/isis-wicket-fullcalendar2[Isis addons' fullcalendar2] wicket extension's `CalendarEventable` interface, meaning ...

image::https://raw.githubusercontent.com/incodehq/incode-module-note/master/images/110-view-on-fullcalendar2.png[link="https://raw.githubusercontent.com/incodehq/incode-module-note/master/images/110-view-on-fullcalendar2.png"]

that it can be rendered on a calendar:

image::https://raw.githubusercontent.com/incodehq/incode-module-note/master/images/120-fullcalendar2.png[link="https://raw.githubusercontent.com/incodehq/incode-module-note/master/images/120-fullcalendar2.png"]




== How to run the Demo App

The prerequisite software is:

* Java JDK 8
* http://maven.apache.org[maven 3] (3.2.x or later is recommended).

To build the demo app:

[source]
----
git clone https://github.com/incodehq/isis-module-note.git
mvn clean install
----

To run the demo app:

[source]
----
cd webapp
mvn jetty:run
----

Then log on using user: `sven`, password: `pass`


== How to configure/use

You can either use this module "out-of-the-box", or you can fork this repo and extend to your own requirements. 

=== "Out-of-the-box"

To use "out-of-the-box":

* update your classpath by adding this dependency in your dom project's `pom.xml`: +
+
[source,xml]
----
<dependency>
    <groupId>org.incode.module.note</groupId>
    <artifactId>incode-module-note-dom</artifactId>
    <version>1.13.0</version>
</dependency>
----

* in the `AppManifest`, update its `getModules()` method: +
+
[source,java]
----
@Override
public List<Class<?>> getModules() {
    return Arrays.asList(
            ...
            org.incode.module.note.dom.NoteModule.class,
    );
}
----


Notes:

* Check for later releases by searching http://search.maven.org/#search|ga|1|incode-module-note-dom[Maven Central Repo].


==== "Out-of-the-box" (-SNAPSHOT)

If you want to use the current `-SNAPSHOT`, then the steps are the same as above, except:

* when updating the classpath, specify the appropriate -SNAPSHOT version:

[source,xml]
----
<version>1.14.0-SNAPSHOT</version>
----

* add the repository definition to pick up the most recent snapshot (we use the Cloudbees continuous integration service).  We suggest defining the repository in a `<profile>`:

[source,xml]
----
<profile>
    <id>cloudbees-snapshots</id>
    <activation>
        <activeByDefault>true</activeByDefault>
    </activation>
    <repositories>
        <repository>
            <id>snapshots-repo<;/id>
            <url>http://repository-estatio.forge.cloudbees.com/snapshot/</url>
            <releases>
                <enabled>false>/enabled>
            </releases>
            <snapshots>
                <enabled>true</enabled>
            </snapshots>
        </repository>
    </repositories>
</profile>
----


=== For each domain object...

In order to be able to attach a note to a domain object, you need to:

* implement a subclass of `NotableLink` to hold a type-safe reference back to the domain object. +
+
This link acts as a type-safe tuple linking the domain object to the `Note`.

* implement the `NotableLinkRepository.SubtypeProvider` SPI interface: +
+
[source,java]
----
public interface SubtypeProvider {
    Class<? extends NotableLink> subtypeFor(Class<?> domainObject);
}
----
+
This tells the module which subclass of `NotableLink` to use to attach to the domain object.  The
`SubtypeProviderAbstract` adapter can be used to remove some boilerplate.

* subclass `T_addNote`, `T_removeNote`, `T_notes` (abstract) mixin classes for the domain object. +
+
These contribute the "notes" collection and actions to add/remove notes for the domain object.

Typically the SPI implementations and the mixin classes are nested static classes of the `NotableLink` subtype.


For example, in the demo app the `NoteDemoObject` domain object can have notes attached to it by virtue of the
`NotableLinkForDemoObject` subclass:

[source,java]
----
@javax.jdo.annotations.PersistenceCapable(identityType= IdentityType.DATASTORE, schema ="incodeNoteDemo")
@javax.jdo.annotations.Inheritance(strategy = InheritanceStrategy.NEW_TABLE)
@DomainObject
public class NotableLinkForDemoObject extends NotableLink {                         // <1>

    private NoteDemoObject demoObject;
    @Column( allowsNull = "false", name = "demoObjectId" )
    public NoteDemoObject getDemoObject() {                                         // <2>
        return demoObject;
    }
    public void setDemoObject(final NoteDemoObject demoObject) {
        this.demoObject = demoObject;
    }

    public Object getNotable() {                                                    // <3>
        return getDemoObject();
    }
    protected void setNotable(final Object object) {
        setDemoObject((NoteDemoObject) object);
    }

    @DomainService(nature = NatureOfService.DOMAIN)
    public static class SubtypeProvider
                extends NotableLinkRepository.SubtypeProviderAbstract {             // <4>
        public SubtypeProvider() {
            super(NoteDemoObject.class, NotableLinkForDemoObject.class);
        }
    }

    @Mixin
    public static class _notes extends T_notes<NoteDemoObject> {                    // <5>
        public _notes(final NoteDemoObject notable) {
            super(notable);
        }
    }
    @Mixin
    public static class _addNote extends T_addNote<NoteDemoObject> {
        public _addNote(final NoteDemoObject notable) {
            super(notable);
        }
    }
    @Mixin
    public static class _removeNote extends T_removeNote<NoteDemoObject> {
        public _removeNote(final NoteDemoObject notable) {
            super(notable);
        }
    }
}
----
<1> extend from `NotableLink`
<2> the type-safe reference property to the "notable" domain object (in this case `DemoObject`).  In the RDBMS
this will correspond to a regular foreign key with referential integrity constraints correctly applied.
<3> implement the hook `setNotable(...)` method to allow the type-safe reference property to the "notable" (in
this case `DemoObject`) to be set.  Also implemented `getNotable()` similarly
<4> implementation of the `SubtypeProvider` SPI domain service, telling the module which subclass of
`NotableLink` to instantiate to attach to the owning domain object
<5> mixins for the collections and actions contributed to the owning domain object




=== SPI

The `CalendarNameRepository` interface can optionally be implemented to specify the available calendars for each "notable" domain object.

For example, in the demo app this is implemented as:

[source,java]
----
@DomainService(nature = NatureOfService.DOMAIN)
public class CalendarNameRepositoryForDemo implements CalendarNameRepository {
    private final Map<Class<?>, List<String>> namesByClass = Maps.newHashMap();
    public CalendarNameRepositoryForDemo() {
        setCalendarNames(NoteDemoObject.class, "BLUE", "GREEN", "RED");
    }
    @Programmatic
    public void setCalendarNames(final Class<?> cls, final String... names) {
        namesByClass.put(cls, Lists.newArrayList(names));
    }
    @Override
    public Collection<String> calendarNamesFor(final Object notable) {
        return namesByClass.get(notable.getClass());
    }
}
----

If no implementation of this interface can be found, then the module provides a single "default" calendar for all "notable" domain objects.


== UI Concerns

=== Suppressing/adding UI elements

Every property, collection and action has a corresponding domain event.  Thus, a subscriber can be used to hide or
disable UI representation of any domain object's members.

For example, the "content" property of a `Note` could be suppressed using the following service:

[source,java]
----
@DomainService(nature = NatureOfService.DOMAIN)
public class NotesDemoSuppressContentSubscriber extends AbstractSubscriber {
    @Subscribe
    public void on(Note.ContentDomainEvent ev) {
        switch (ev.getEventPhase()) {
        case HIDE:
            // uncomment as an example of how to influence the UI
            // (the content property should disappear)
            // ev.hide();
        }
    }
}
----

Conversely, new UI elements can be added using
link:http://isis.apache.org/guides/ug.html#_ug_how-tos_contributed-members[contributions] and mixins.


=== Link class

The `NotableLink` object is not intended to be rendered directly in the UI.  Rather, the
`T_notes` mixin renders the referenced ``Note``s instead.

Nevertheless (just in case there is a requirement to render the link object), the `NotableLink` allows
its title, icon and CSS class to be specified using subscribers to UI event classes specific to the link class.



== Other Services

The module provides the following domain services for querying notes:

* `NoteRepository` +
+
To search for notes by "notable" or in general within a date range

* `NotableLinkRepository` +
+
To search for ``NotableLink``s, ie the tuple that links a `Note` with an arbitrary "notable" domain object.  This repository is likely to be less useful than `NoteRepository`, but is crucial to the internal workings of the `incode-module-note` module.



== Known issues

None at this time.

== Change Log

* `1.13.0-SNAPSHOT` - (to release) against Isis 1.13.0; removed the `Notable` interface  and changed implementation to
remove dependency on the http://github.com/isisaddons/isis-module-poly[Isis addons' poly]; also uses `.layout.xml`
for layouts
* `1.12.1` - released against Isis 1.12.1, fixes #4.
* `1.12.0` - released against Isis 1.12.0.
* `1.11.0` - released against Isis 1.11.0.
* `1.10.0` - released against Isis 1.10.0.
* `1.9.0` - released against Isis 1.9.0.



== Forking the repo

If instead you want to extend this module's functionality, then we recommend that you fork this repo.  The repo is
structured as follows:

* `pom.xml` - parent pom
* `app` - the demo webapp's `AppManifest`
* `dom` - the module implementation, depends on Isis applib
* `fixture` - fixtures, holding a sample domain objects and fixture scripts; depends on `dom`
* `integtests` - integration tests for the module; depends on `fixture`
* `webapp` - demo webapp (see above screenshots); depends on `dom` and `fixture`

Only the `dom` project is released to Maven Central Repo.  The versions of the other modules are purposely left at
`0.0.1-SNAPSHOT` because they are not intended to be released.

Note that the module uses link:https://projectlombok.org/[Project Lombok].  To compile the code within your IDE you will
therefore require the appropriate Lombok plugin.  See the link:https://projectlombok.org/download.html[Lombok download page] for more information.


== Legal Stuff

=== License

[source]
----
Copyright 2015-2016 Dan Haywood

Licensed under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
----

=== Dependencies

Depends upon:

* http://github.com/isisaddons/isis-module-poly[Isis addons' poly] module
* http://github.com/isisaddons/isis-wicket-fullcalendar2[Isis addons' fullcalendar2] wicket extension

both released under Apache v2 license.


=== Icons

The icon for the `Note` entity is provided by https://icons8.com/[Icons8].


==  Maven deploy notes

Only the `dom` module is deployed, and is done so using Sonatype's OSS support (see
http://central.sonatype.org/pages/apache-maven.html[user guide]).

=== Release to Sonatype's Snapshot Repo

To deploy a snapshot, use:

[source]
----
pushd dom
mvn clean deploy
popd
----

The artifacts should be available in Sonatype's
https://oss.sonatype.org/content/repositories/snapshots[Snapshot Repo].



=== Release to Maven Central

The `release.sh` script automates the release process. It performs the following:

* performs a sanity check (`mvn clean install -o`) that everything builds ok
* bumps the `pom.xml` to a specified release version, and tag
* performs a double check (`mvn clean install -o`) that everything still builds ok
* releases the code using `mvn clean deploy`
* bumps the `pom.xml` to a specified release version

For example:

[source]
----
sh release.sh 1.13.0 \
              1.14.0-SNAPSHOT \
              dan@haywood-associates.co.uk \
              "this is not really my passphrase"
----

where
* `$1` is the release version
* `$2` is the snapshot version
* `$3` is the email of the secret key (`~/.gnupg/secring.gpg`) to use for signing
* `$4` is the corresponding passphrase for that secret key.

Other ways of specifying the key and passphrase are available, see the `pgp-maven-plugin`'s
http://kohsuke.org/pgp-maven-plugin/secretkey.html[documentation]).

If the script completes successfully, then push changes:

[source]
----
git push origin master
git push origin 1.13.0
----

If the script fails to complete, then identify the cause, perform a `git reset --hard` to start over and fix the issue
before trying again.  Note that in the `dom`'s `pom.xml` the `nexus-staging-maven-plugin` has the 
`autoReleaseAfterClose` setting set to `true` (to automatically stage, close and the release the repo).  You may want
to set this to `false` if debugging an issue.

According to Sonatype's guide, it takes about 10 minutes to sync, but up to 2 hours to update http://search.maven.org[search].



= incode-module-alias
:_imagesdir: ./

image:https://travis-ci.org/incodehq/incode-module-alias.png?branch=master[Build Status,link=https://travis-ci.org/incodehq/incode-module-alias]

This module, intended for use with link:http://isis.apache.org[Apache Isis], provides the ability to attach `Alias`
objects to arbitrary domain objects.  There are _no_ requirements for those domain objects implement any interfaces.
A subclass of the `AliasLink` abstract class (about 40 lines of boilerplate, details below) is required, acting
as the "glue" between the alias and the "aliased" domain object.

Each `Alias` simply holds a string reference, typically corresponding to an identifier of the "aliased" object within
an external systems.  For example, a `Party` entity might have a different identifier within a general ledger system,
and another identifier again in a document management system.

In fact, aliases are qualified in two ways: first by the "alias type" (general ledger, document management system", and
also by an "application tenancy path".  This is the same concept as exists within the
link:http://www.isisaddons.org[Isis Addons]' link:http://github.com/isisaddons/isis-module-security[security] module,
and generally represents a multi-tenancy environment, eg to distinguish different countries.

_This_ module places no constraints on either the alias type nor on the format of the application tenancy path.  The
alias type is represented by the `AliasType`; to use the module the application must implement the mandatory
`AliasTypeRepository` SPI service which identifies the available `AliasType`s.  Similarly, the available application
tenancy paths are provided to the module by the mandatory `ApplicationTenancyRepository` SPI service.  In both cases
the list of alias types and application tenancy paths is per aliased domain object; not every aliased object will have
an alias in every external system.

In summary, to use this module the consuming application must:

* provide a subclass of `AliasLink`, being the tuple linking the `Alias` to the "aliased" domain object
* provide an implementation of the `ApplicationTenancyRepository` SPI service
* provide an implementation of the `AliasType` interface.


== Screenshots

The following screenshots show an example app's usage of the module.

We start by installing some demo fixture data:

image::https://raw.githubusercontent.com/incodehq/incode-module-alias/master/images/010-run-fixture-script.png[link="https://raw.githubusercontent.com/incodehq/incode-module-alias/master/images/010-run-fixture-script.png"]

This installs some very simple (demo) domain objects, the first of which is returned.  These aliasable objects have
a (contributed) `aliases` collection, and we can also add new aliases using a (contributed) `addAlias(...)` action:

image::https://raw.githubusercontent.com/incodehq/incode-module-alias/master/images/040-add-alias.png[link="https://raw.githubusercontent.com/incodehq/incode-module-alias/master/images/040-add-alias.png"]

The action requires the application tenancy of the alias (as returned from the `ApplicationTenancyRepository` SPI service) to be specified:

image::https://raw.githubusercontent.com/incodehq/incode-module-alias/master/images/050-enter-alias-details.png[link="https://raw.githubusercontent.com/incodehq/incode-module-alias/master/images/050-enter-alias-details.png"]

and also the alias type (as returned from the `AliasTypeRepository` SPI service) to be specified:

image::https://raw.githubusercontent.com/incodehq/incode-module-alias/master/images/052-enter-alias-details.png[link="https://raw.githubusercontent.com/incodehq/incode-module-alias/master/images/052-enter-alias-details.png"]

and finally the external alias reference itself must be specified also:

image::https://raw.githubusercontent.com/incodehq/incode-module-alias/master/images/054-enter-alias-details.png[link="https://raw.githubusercontent.com/incodehq/incode-module-alias/master/images/054-enter-alias-details.png"]


The aliases for the `Alias` domain object is added to:

image::https://raw.githubusercontent.com/incodehq/incode-module-alias/master/images/060-alias_added_to_collection.png[link="https://raw.githubusercontent.com/incodehq/incode-module-alias/master/images/060-alias_added_to_collection.png"]

Each `Alias` can also be viewed:

image::https://raw.githubusercontent.com/incodehq/incode-module-alias/master/images/070-view-alias.png[link="https://raw.githubusercontent.com/incodehq/incode-module-alias/master/images/070-view-alias.png"]



== How to run the Demo App

The prerequisite software is:

* Java JDK 8
* http://maven.apache.org[maven 3] (3.2.x or later is recommended).

To build the demo app:

[source]
----
git clone https://github.com/incodehq/isis-module-alias.git
mvn clean install
----

To run the demo app:

[source]
----
mvn antrun:run -P self-host
----

Then log on using user: `sven`, password: `pass`


== How to configure/use

You can either use this module "out-of-the-box", or you can fork this repo and extend to your own requirements. 

=== "Out-of-the-box"

To use "out-of-the-box":

* update your classpath by adding this dependency in your dom project's `pom.xml`: +
+
[source,xml]
----
<dependency>
    <groupId>org.incode.module.alias</groupId>
    <artifactId>incode-module-alias-dom</artifactId>
    <version>1.12.0</version>
</dependency>
----

* in the `AppManifest`, update its `getModules()` method: +
+
[source,java]
----
@Override
public List<Class<?>> getModules() {
    return Arrays.asList(
            ...
            org.incode.module.alias.dom.AliasModule.class,
    );
}
----



Notes:

* Check for later releases by searching http://search.maven.org/#search|ga|1|incode-module-alias-dom[Maven Central Repo]).


==== "Out-of-the-box" (-SNAPSHOT)

If you want to use the current `-SNAPSHOT`, then the steps are the same as above, except:

* when updating the classpath, specify the appropriate -SNAPSHOT version:

[source,xml]
----
<version>1.13.0-SNAPSHOT</version>
----

* add the repository definition to pick up the most recent snapshot (we use the Cloudbees continuous integration service).  We suggest defining the repository in a `<profile>`:

[source,xml]
----
<profile>
    <id>cloudbees-snapshots</id>
    <activation>
        <activeByDefault>true</activeByDefault>
    </activation>
    <repositories>
        <repository>
            <id>snapshots-repo<;/id>
            <url>http://repository-estatio.forge.cloudbees.com/snapshot/</url>
            <releases>
                <enabled>false>/enabled>
            </releases>
            <snapshots>
                <enabled>true</enabled>
            </snapshots>
        </repository>
    </repositories>
</profile>
----


=== For each domain object...

In order to be able to add/remove aliases to a domain object, you need to:

* implement a subclass of `AliasLink` for the domain object's type.  +
+
This link acts as a type-safe tuple linking the domain object to the `Alias`.

* implement an SPI interface to specify the subclass of `AliasLink` to use to link the "aliased" domain object to the `Alias`.

* subclass `T_addAlias`, `T_removeAlias` and `T_aliases` (abstract) mixin classes for the domain object. +
+
This contributes the "aliases" collection and actions to add and remove aliases.

Typically the SPI implementations and the mixin classes are nested static classes of the `AliasLink` subtype.

For example, in the demo app the `AliasDemoObject` domain object can have aliases by virtue of the
`AliasLinkForDemoObject` subclass:

[source,java]
----
@javax.jdo.annotations.PersistenceCapable(
        identityType= IdentityType.DATASTORE,
        schema="aliasdemo")
@javax.jdo.annotations.Inheritance(strategy = InheritanceStrategy.NEW_TABLE)
@DomainObject(objectType = "aliasdemo.AliasLinkForDemoObject")
public class AliasLinkForDemoObject extends AliasLink {                                     // <1>

    private AliasDemoObject demoObject;

    @Column(
            allowsNull = "false",
            name = "demoObjectId"
    )
    public AliasDemoObject getDemoObject() {                                                // <2>
        return demoObject;
    }

    public void setDemoObject(final AliasDemoObject demoObject) {
        this.demoObject = demoObject;
    }

    @Override
    public Object getAliased() {                                                            // <3>
        return getDemoObject();
    }

    @Override
    protected void setAliased(final Object aliased) {
        setDemoObject((AliasDemoObject) aliased);
    }

    @DomainService(nature = NatureOfService.DOMAIN)
    public static class LinkProvider extends AliasLinkRepository.LinkProviderAbstract {     // <4>
        public LinkProvider() {
            super(AliasDemoObject.class, AliasLinkForDemoObject.class);
        }
    }

    @Mixin
    public static class _aliases extends T_aliases<AliasDemoObject> {                       // <5>
        public _aliases(final AliasDemoObject aliased) {
            super(aliased);
        }
    }

    @Mixin
    public static class _addAlias extends T_addAlias<AliasDemoObject> {                     // <5>
        public _addAlias(final AliasDemoObject aliased) {
            super(aliased);
        }
    }

    @Mixin
    public static class _removeAlias extends T_removeAlias<AliasDemoObject> {               // <5>
        public _removeAlias(final AliasDemoObject aliased) {
            super(aliased);
        }
    }

}
----
<1> extend from `AliasLink`
<2> the type-safe reference property to the "aliased" domain object (in this case `AliasDemoObject`).  In the RDBMS
this will correspond to a regular foreign key with referential integrity constraints correctly applied.
<3> implement the hook `setAliased(...)` method to allow the type-safe reference property to the "aliased" (in this
case `AliasDemoObject`) to be set.  Also implemented `getAliased()` similarly
<4> implementation of the `LinkProvider` SPI domain service, telling the module which subclass of `AliasLink`
to instantiate to handle the polymorphic link between `Alias` and the "aliased" domain object
<5> mixin the collections and actions onto the "aliased" domain object


=== SPI services

There are two further mandatory SPI domain services that must be implemented.

First, the `ApplicationTenancyRepository` returns the application tenancy (path)s that are available to locate
``Alias``es for a given aliased:

[source,java]
----
public interface ApplicationTenancyRepository {
    Collection<String> atPathsFor(final Object aliased);
}
----
Note that this isn't (necessarily) the same as the application tenancy path of the object being aliased; rather it is
the list of those paths available.

Second, the `AliasTypeRepository` interface returns the available alias types for a given application tenancy path and
aliased:

[source,java]
----
public interface AliasTypeRepository {
    Collection<AliasType> aliasTypesFor(final Object aliased, final String atPath);
}
----

where `AliasType` is defined as the interface:

[source,java]
----
public interface AliasType {
    String getId();
}
----
Typically `AliasType` will be implemented as an entity or perhaps a view model.  The "id" is used as a column in
the database tables, but in the UI the end-user sees the title of the object that implements the interface.

[WARNING]
====
Currently (as of v1.13.0) the Apache Isis framework does not support enums implementing interfaces; the example app
shows how a view model can be used as a work-around.
====


Note that there can be multiple implementations of either of these interfaces.  This is to support the use case that
different unrelated entities in the application may have aliases; each such aliased object can have its own supporting
implementations of these SPI interfaces.



== Other Services

The module provides the following domain services for querying aliases:

* `AliasRepository` +
+
To search for aliases by "aliased" object

* `AliasLinkRepository` +
+
To search for ``AliasLink``s, ie the tuple that links an `Alias` with an arbitrary "aliased" domain object.
This repository allows for links to be searched by either the aliased object, or application tenancy path, or alias
type, in any combination.

The module also allows the title, icon and CSS for `Alias` objects to be overridden.  This is done by providing
subscribers that override the default `Alias.TitleSubscriber`, `Alias.IconSubscriber` and `Alias.CssClassSubscriber`
implementations.

For example, the demo app has this demo implementation:

[source,java]
----
@DomainService(nature = NatureOfService.DOMAIN )
public class DemoUiSubscriber extends AbstractSubscriber {

    @Subscribe
    public void on(Alias.TitleUiEvent ev) {
        Alias alias = ev.getSource();
        if(isType(alias, AliasTypeDemoEnum.DOCUMENT_MANAGEMENT)) {
            ev.setTitle("DocMgmt  [" + alias.getAliasTypeId() + "] " + alias.getReference());
        }
    }

    @Subscribe
    public void on(Alias.IconUiEvent ev) {
        Alias alias = ev.getSource();
        if(isType(alias, AliasTypeDemoEnum.DOCUMENT_MANAGEMENT)) {
            ev.setIconName("Alias-docMgmt");
        } else if (isType(alias, AliasTypeDemoEnum.GENERAL_LEDGER)) {
            ev.setIconName("Alias-GL");
        }
    }

    @Subscribe
    public void on(Alias.CssClassUiEvent ev) {
        Alias alias = ev.getSource();
        ev.setCssClass("Alias" + alias.getAtPath().replace("/", "-"));
    }

    private static boolean isType(final Alias alias, final AliasTypeDemoEnum aliasType) {
        return alias.getAliasTypeId().equals(aliasType.getId());
    }
}
----

which returns a different title, icon and alias.  Custom png icons and CSS are also supplied in the demo app (icons
in the fixtures module, custom CSS in the webapp module).



== Known issues

None at this time.

== Change Log

* `1.13.0-SNAPSHOT` - (to release) against Isis 1.13.0; removed the `Aliasable` interface (to completely decouple the
"aliased" domain object from this module); removed dependency on poly module, instead using the (broadly equivalent)
new `LinkProvider` SPI; added in the ability to override the title, icon and CSS of `Alias` objects;
using `.layout.xml` for layouts.
* `1.12.0` - released against Isis 1.12.0
* `1.11.1` - released against Isis 1.11.1.



== Forking the repo

If instead you want to extend this module's functionality, then we recommend that you fork this repo.  The repo is
structured as follows:

* `pom.xml` - parent pom
* `app` - the demo webapp's `AppManifest`
* `dom` - the module implementation, depends on Isis applib
* `fixture` - fixtures, holding a sample domain objects and fixture scripts; depends on `dom`
* `integtests` - integration tests for the module; depends on `fixture`
* `webapp` - demo webapp (see above screenshots); depends on `dom` and `fixture`

Only the `dom` project is released to Maven Central Repo.  The versions of the other modules are purposely left at
`0.0.1-SNAPSHOT` because they are not intended to be released.

Note that the module uses link:https://projectlombok.org/[Project Lombok].  To compile the code within your IDE you will
therefore require the appropriate Lombok plugin.  See the link:https://projectlombok.org/download.html[Lombok download page] for more information.


== Legal Stuff

=== License

[source]
----
Copyright 2016 Dan Haywood

Licensed under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
----

=== Dependencies

None.


=== Icons

The icons are provided by https://icons8.com/[Icons8].


==  Maven deploy notes

Only the `dom` module is deployed, and is done so using Sonatype's OSS support (see
http://central.sonatype.org/pages/apache-maven.html[user guide]).

=== Release to Sonatype's Snapshot Repo

To deploy a snapshot, use:

[source]
----
pushd dom
mvn clean deploy
popd
----

The artifacts should be available in Sonatype's
https://oss.sonatype.org/content/repositories/snapshots[Snapshot Repo].



=== Release to Maven Central

The `release.sh` script automates the release process. It performs the following:

* performs a sanity check (`mvn clean install -o`) that everything builds ok
* bumps the `pom.xml` to a specified release version, and tag
* performs a double check (`mvn clean install -o`) that everything still builds ok
* releases the code using `mvn clean deploy`
* bumps the `pom.xml` to a specified release version

For example:

[source]
----
sh release.sh 1.13.0 \
              1.14.0-SNAPSHOT \
              dan@haywood-associates.co.uk \
              "this is not really my passphrase"
----

where
* `$1` is the release version
* `$2` is the snapshot version
* `$3` is the email of the secret key (`~/.gnupg/secring.gpg`) to use for signing
* `$4` is the corresponding passphrase for that secret key.

Other ways of specifying the key and passphrase are available, see the `pgp-maven-plugin`'s
http://kohsuke.org/pgp-maven-plugin/secretkey.html[documentation]).

If the script completes successfully, then push changes:

[source]
----
git push origin master
git push origin 1.13.0
----

If the script fails to complete, then identify the cause, perform a `git reset --hard` to start over and fix the issue
before trying again.  Note that in the `dom`'s `pom.xml` the `nexus-staging-maven-plugin` has the 
`autoReleaseAfterClose` setting set to `true` (to automatically stage, close and the release the repo).  You may want
to set this to `false` if debugging an issue.

According to Sonatype's guide, it takes about 10 minutes to sync, but up to 2 hours to update http://search.maven.org[search].

